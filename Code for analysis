

# Getting set up
mkdir Qiime # Make a directory called Qiime on the desktop
cd ~/Desktop/Qiime # Make Qiime your current working directory

#Downloading data files

# Download sample-metadata file from - https://data.qiime2.org/2017.8/tutorials/atacama-soils/sample_metadata.tsv into current working directory
# The sequencing type is "paired-end-sequencing" hence we will have to download the forward and reverse sequencing read
# make a directory called sequences to store all the sequences and barcode you will download below

mkdir sequences

# Download forward sequencing reads from - https://data.qiime2.org/2017.8/tutorials/atacama-soils/10p/forward.fastq.gz, save as "forward.fastaq.gz"
# Download the reverse sequencing reads from - https://data.qiime2.org/2017.8/tutorials/atacama-soils/10p/reverse.fastq.gz, save as "reverse.fastaq.gz"
# Download the barcodes file for the sequencing from -  https://data.qiime2.org/2017.8/tutorials/atacama-soils/10p/barcodes.fastq.gz, save as "barcodes.fastaq.gz"

# Sequence Pre-processing 
# Import the sequences and barcode file (barcode associated with each sequence) into a Qiime artifact 

qiime tools import \
   --type EMPPairedEndSequences \
   --input-path sequences \
   --output-path sequences.qza
   
# Demultiplexing - we will demultiplex the sequence.qza files to identify sequence reads associated with each sample. For this we will utilize the sample-metadata file which has information on the barcode associated with a particular sample
# Within the sample metadata file the barcodes are present in a column called "BarcodeSequence"
# --p-reve-comp-mapping-barcodes indicates that the barcode reads are the reverse complement of what is listed on the sample-metadata file

qiime demux emp-paired \
  --m-barcodes-file sample-metadata.tsv \
  --m-barcodes-category BarcodeSequence \
  --i-seqs sequences.qza \
  --o-per-sample-sequences demux \
  --p-rev-comp-mapping-barcodes

# Create a summary of the results using the following

qiime demux summarize \
  --i-data demux.qza \
  --o-visualization demux.qzv

# View the summary using the following command. The interactive plots are a great way to indentify where you sequences need to be trimmed

qiime tools view demux.qzv

# Denoise the de-multiplexed sequences to denoise the sequences. The same trimming parameters are used as the Qiime "Atacama Soil Microbiome" tutorial
# The outputs are a "feature table" - table.qza and a "representative sequences" - rep-seqs.qza

qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux.qza \
  --o-table table \
  --o-representative-sequences rep-seqs \
  --p-trim-left-f 13 \
  --p-trim-left-r 13 \
  --p-trunc-len-f 150 \
  --p-trunc-len-r 150
  
# Summarizing feature table
 
 qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file sample-metadata.tsv

# View feature table. The feature table is good summary of number of sequences per sample, OTU (feature) distribution, sample parameter distribution 

qiime tools view table.qzv

# Summarize representative sequences

qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv

# View representative sequences. This lets you BLAST sequences directly from an interactive browser page

qiime tools view rep-seqs.qzv
